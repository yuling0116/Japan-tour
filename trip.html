<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å²¡å±±ä¹‹æ—…âœˆï¸</title>
    <style>
        /* CSS è®Šæ•¸ï¼šæ‰€æœ‰é¡è‰²éƒ½å®šç¾©åœ¨é€™è£¡ */
        :root {
            --primary: #2c3e50; /* ä¸»è¦å¼·èª¿è‰² (å°è¦½åˆ—èƒŒæ™¯ã€æ¨™é¡Œ) */
            --accent: #e67e22;  /* æ¬¡è¦å¼·èª¿è‰² (å¡ç‰‡é‚Šç·šã€æ™‚é–“ã€Active Tab) */
            --bg-color: #f4f6f7; /* ç¶²é èƒŒæ™¯è‰² */
            --card-bg: #ffffff;  /* å¡ç‰‡èƒŒæ™¯è‰² */
            --text-color: #333;  /* ä¸»è¦æ–‡å­—é¡è‰² */
            --btn-blue: #3498db;
            --btn-green: #2ecc71;
            --btn-red: #e74c3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é ‚éƒ¨å°è¦½åˆ— */
        .header-bar {
            background: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .design-btn-container {
            display: flex;
            justify-content: flex-end;
            padding: 5px 20px 0;
        }

        .design-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 5px;
        }
        
        .design-btn:hover { background: #d35400; }

        .date-tabs {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 0 10px 0;
        }

        .date-tab {
            background: transparent;
            color: rgba(255,255,255,0.8);
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            flex-shrink: 0;
        }

        .date-tab.active {
            color: white;
            font-weight: bold;
            border-bottom: 3px solid var(--accent);
        }

        /* å…§å®¹å€åŸŸ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .day-info {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        /* è¡Œç¨‹å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            display: flex;
            align-items: flex-start;
            border-left: 5px solid var(--accent);
            transition: transform 0.2s;
        }
        
        /* æ–°å¢ï¼šç”¨æ–¼ç·¨è¼¯å¾Œé«˜äº®é¡¯ç¤º */
        .card.highlight {
            border: 2px solid var(--btn-blue);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
            animation: highlight-fade 2s forwards;
        }
        
        @keyframes highlight-fade {
            0% { transform: scale(1.02); }
            50% { background-color: #f7fbfe; }
            100% { transform: scale(1); background-color: var(--card-bg); border: 1px solid #ddd; }
        }


        .time-box {
            min-width: 65px;
            font-weight: bold;
            color: var(--accent);
            font-size: 14px;
            margin-right: 15px;
            padding-top: 5px;
        }
        
        .url-status {
            font-size: 0.7em;
            color: var(--btn-green);
            margin-top: 3px;
        }
        
        .content-box {
            flex-grow: 1; /* è®“å…§å®¹ä½”æ»¿ç©ºé–“ */
            padding-right: 10px;
        }
        
        .activity {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 3px;
        }
        
        .note {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        /* æ“ä½œæŒ‰éˆ•å€ */
        .action-icons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 10px;
            border-left: 1px solid #eee;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover { background-color: #f0f0f0; }
        .btn-map { color: var(--btn-green); }
        .btn-edit { color: var(--btn-blue); }
        .btn-del { color: var(--btn-red); }

        /* åº•éƒ¨æµ®å‹•æŒ‰éˆ• (FAB) */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 200;
        }

        .fab {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab.reset { background: var(--btn-red); font-size: 18px; }

        /* === Modal æ¨£å¼ (ä¸»é¡Œ/æ–°å¢/ç·¨è¼¯ å½ˆçª—) === */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .theme-previews {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-card {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: border-color 0.2s;
        }
        
        .theme-card.active {
            border-color: var(--btn-blue);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .theme-card div {
            width: 100%;
            height: 20px;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        /* é è¦½é¡è‰² */
        .preview-setouchi .p-primary { background: #2c3e50; }
        .preview-setouchi .p-accent { background: #e67e22; }
        .preview-sakura .p-primary { background: #e91e63; }
        .preview-sakura .p-accent { background: #ffc0cb; }
        .preview-mono .p-primary { background: #333; }
        .preview-mono .p-accent { background: #7f8c8d; }

        /* è‡ªè¨‚é¡è‰²å€ */
        .custom-color-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-color-group label {
            width: 100px;
            font-weight: bold;
        }

        .custom-color-group input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            width: 30px;
            height: 30px;
            padding: 0;
            cursor: pointer;
            border-radius: 50%;
            outline: none;
        }

        .custom-color-group input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .apply-custom-btn {
            width: 100%;
            background: var(--btn-blue);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .apply-custom-btn:hover { background: #2980b9; }

    </style>
</head>
<body>
    
    <div id="designModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">Ã—</span>
            <h3>ğŸ¨ ç¶²é è¨­è¨ˆä¸»é¡Œ</h3>
            <p>é»æ“Šä¸‹æ–¹ä¸»é¡Œå³å¯é è¦½ä¸¦å¥—ç”¨ï¼š</p>

            <div class="theme-previews">
                <div class="theme-card preview-setouchi" onclick="applyTheme('setouchi')">
                    <div class="p-primary"></div>
                    <div class="p-accent"></div>
                    <small>ç€¨æˆ¶å…§æµ·è—</small>
                </div>

                <div class="theme-card preview-sakura" onclick="applyTheme('sakura')">
                    <div class="p-primary"></div>
                    <div class="p-accent"></div>
                    <small>æ«»èŠ±ç²‰å«©é¢¨</small>
                </div>

                <div class="theme-card preview-mono" onclick="applyTheme('mono')">
                    <div class="p-primary"></div>
                    <div class="p-accent"></div>
                    <small>æ¥µç°¡é»‘ç™½ç°</small>
                </div>
            </div>

            <h4>è‡ªè¨‚é¡è‰² (HEX Code)</h4>
            <div class="custom-color-group">
                <label for="custom-primary">å°è¦½åˆ—/æ¨™é¡Œè‰²:</label>
                <input type="color" id="color-primary" value="#2c3e50">
                <input type="text" id="hex-primary" value="#2c3e50" oninput="document.getElementById('color-primary').value = this.value">
            </div>
            
            <div class="custom-color-group">
                <label for="custom-accent">å¼·èª¿/æ™‚é–“è‰²:</label>
                <input type="color" id="color-accent" value="#e67e22">
                <input type="text" id="hex-accent" value="#e67e22" oninput="document.getElementById('color-accent').value = this.value">
            </div>
            
            <button class="apply-custom-btn" onclick="applyCustomColors()">å¥—ç”¨è‡ªè¨‚é¡è‰²</button>
        </div>
    </div>


    <div class="header-bar">
        <div class="design-btn-container">
            <button class="design-btn" onclick="openModal()">ğŸ¨ è¨­è¨ˆä¸»é¡Œ</button>
        </div>
        <div class="date-tabs" id="tabs-container"></div>
    </div>

    <div class="container">
        <h2 id="current-date-display"></h2>
        <p class="day-info" id="current-location-display"></p>

        <div id="itinerary-list"></div>
    </div>

    <div class="fab-container">
        <button class="fab reset" onclick="resetData()" title="é‡ç½®è¡Œç¨‹">â†»</button>
        <button class="fab" onclick="addNewItem()" title="æ–°å¢è¡Œç¨‹">ï¼‹</button>
    </div>

    <script>
        // --- ä¸»é¡Œè¨­å®š (ç„¡è®Šå‹•) ---
        const THEMES = {
            'setouchi': { 
                name: 'ç€¨æˆ¶å…§æµ·è—', primary: '#2c3e50', accent: '#e67e22', bg: '#f4f6f7', card: '#ffffff', text: '#333'
            },
            'sakura': { 
                name: 'æ«»èŠ±ç²‰å«©é¢¨', primary: '#e91e63', accent: '#ffc0cb', bg: '#fff0f5', card: '#ffffff', text: '#555'
            },
            'mono': { 
                name: 'æ¥µç°¡é»‘ç™½ç°', primary: '#333333', accent: '#7f8c8d', bg: '#ffffff', card: '#f5f5f5', text: '#222'
            }
        };

        // --- è¡Œç¨‹è³‡æ–™ (å·²æª¢æŸ¥ JSON æ ¼å¼) ---
        const defaultData = {
            "2026-01-10": { label: "1/10 (å…­)", location: "ğŸ“ å€‰æ•·", items: [{ time: "ä¸Šåˆ", activity: "æŠµé”å€‰æ•· â†’ å…¥ä½å°æœ¨å±‹", note: "å…ˆå¯„æ”¾è¡Œææˆ–è¾¦ç†å…¥ä½", url: "" }, { time: "ä¸‹åˆ", activity: "å€‰æ•·ç¾è§€åœ°å€", note: "å¤§åŸç¾è¡“é¤¨ã€é‹æ²³æ•£æ­¥", url: "" }, { time: "æ™šä¸Š", activity: "å€‰æ•·è€è¡—æ™šé¤", note: "æ‰¾é–“å’–å•¡å»³æˆ–å°é…’é¤¨äº«å—æ°›åœ", url: "" }, { time: "ä½å®¿", activity: "å€‰æ•·å°æœ¨å±‹", note: "ä¼‘æ¯é¤Šç²¾è“„éŠ³", url: "" }] },
            "2026-01-11": { label: "1/11 (æ—¥)", location: "ğŸ“ ç›´å³¶ä¸€æ—¥éŠ", items: [{ time: "08:00", activity: "å®‡é‡æ¸¯", note: "æ­èˆ¹å‰å¾€ç›´å³¶å®®æµ¦æ¸¯", url: "" }, { time: "ä¸Šåˆ", activity: "ç›´å³¶å®¶è¨ˆåŠƒ", note: "ANDO MUSEUMã€å—å¯ºã€ç¢æœƒæ‰€/è§’å±‹", url: "" }, { time: "ä¸­åˆ", activity: "æœ¬æ‘åˆé¤", note: "æœ¬æ‘åœ°å€äº«ç”¨åˆé¤", url: "" }, { time: "ä¸‹åˆ", activity: "Benesse House Museum", note: "æˆ¶å¤–ä½œå“æ•£æ­¥ã€å¿…æ‹é»ƒå—ç“œğŸŸ¡", url: "" }, { time: "å‚æ™š", activity: "å®‡é‡æ¸¯", note: "æ­èˆ¹å›ç¨‹ â†’ å›å€‰æ•·", url: "" }] },
            "2026-01-12": { label: "1/12 (ä¸€)", location: "ğŸ“ å€‰æ•· â†’ å°¾é“", items: [{ time: "ä¸Šåˆ", activity: "ç§»å‹•åˆ°å°¾é“", note: "è»Šç¨‹ç´„ 1.5 å°æ™‚", url: "" }, { time: "11:00", activity: "å°¾é“æœ¬é€šã‚Šå•†åº—è¡—", note: "è€è¡—æ•£æ­¥ã€è²“ä¹‹å°å··ã€å‚é“æ‹ç…§", url: "" }, { time: "ä¸‹åˆ", activity: "åƒå…‰å¯ºå…¬åœ’", note: "æ­çºœè»Šæ¬£è³ç€¨æˆ¶å…§æµ·æ™¯è‰²", url: "" }, { time: "æ™šä¸Š", activity: "å°¾é“ã¿ã¯ã‚‰ã—äº­", note: "å…¥ä½ Guest Houseï¼Œå¤œæ™¯æ•£æ­¥", url: "" }] },
            "2026-01-13": { label: "1/13 (äºŒ)", location: "ğŸ“ å°¾é“ï¼è·³å³¶", items: [{ time: "ä¸Šåˆ", activity: "å‘å³¶", note: "æˆ–ç”Ÿå£å³¶ï¼Œç§Ÿå€Ÿè‡ªè¡Œè»Šæ•£æ­¥æ‹ç…§ğŸš²", url: "" }, { time: "ä¸‹åˆ", activity: "å°¾é“å¸‚å€", note: "é›»å½±è¡—é“æ‹ç…§ã€ç‰¹è‰²å°åº—", url: "" }, { time: "æ™šä¸Š", activity: "å°¾é“ã¿ã¯ã‚‰ã—äº­", note: "ä¼‘æ¯", url: "" }] },
            "2026-01-14": { label: "1/14 (ä¸‰)", location: "ğŸ“ å°¾é“ â†’ è’œå±±", items: [{ time: "ä¸Šåˆ", activity: "ç§»å‹•åˆ°è’œå±±", note: "è»Šç¨‹ç´„ 2 å°æ™‚", url: "" }, { time: "ä¸‹åˆ", activity: "è’œå±±é«˜åŸä¸­å¿ƒ Joyful Park", note: "ç‰§å ´é¤µç¾ŠğŸ‘ã€æ•£æ­¥", url: "" }, { time: "æ™šä¸Š", activity: "è’œå±±è¬æ¥“é…’åº—", note: "æ™šé¤ & ä½å®¿", url: "" }] },
            "2026-01-15": { label: "1/15 (å››)", location: "ğŸ“ è’œå±±æ”¾é¬†æ—¥", items: [{ time: "ä¸Šåˆ", activity: "é“ã®é§… é¢¨ã®å®¶", note: "é€›è’œå±±åœŸç”¢åº—", url: "" }, { time: "ä¸‹åˆ", activity: "è’œå±±æº«æ³‰", note: "é«˜åŸæ•£ç­–ã€æ³¡æº«æ³‰æ”¾é¬†", url: "" }, { time: "æ™šä¸Š", activity: "è’œå±±è¬æ¥“é…’åº—", note: "ä½å®¿", url: "" }] },
            "2026-01-16": { label: "1/16 (äº”)", location: "ğŸ“ è’œå±± â†’ å²¡å±±å¸‚å€", items: [{ time: "ä¸Šåˆ", activity: "ç§»å‹•åˆ°å²¡å±±", note: "è»Šç¨‹ç´„ 1.5 å°æ™‚", url: "" }, { time: "ä¸‹åˆ", activity: "å²¡å±±å¾Œæ¨‚åœ’", note: "æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€ + å²¡å±±åŸ", url: "" }, { time: "æ™šä¸Š", activity: "è¡¨ç”ºå•†åº—è¡—", note: "æ¡ƒå¤ªéƒé€šé€›è¡—ã€ç¾é£Ÿ", url: "" }, { time: "ä½å®¿", activity: "å²¡å±±å¸‚å€", note: "æ‰¾ä¸€é–“å–œæ­¡çš„é£¯åº—", url: "" }] },
            "2026-01-17": { label: "1/17 (å…­)", location: "ğŸ“ å°è±†å³¶ æˆ– å¸‚å€æ·±åº¦", items: [{ time: "é¸é …A", activity: "å°è±†å³¶å¤©ä½¿ä¹‹è·¯", note: "å®‡é‡æ¸¯â†’åœŸåº„æ¸¯ã€‚é†¬ä¹‹é„‰ã€å¯’éœæºª", url: "" }, { time: "é¸é …B", activity: "å‰å‚™æ´¥ç¥ç¤¾", note: "å¸‚å€æ·±åº¦éŠã€çƒåŸå…¬åœ’ã€æœ€å¾Œæ¡è³¼", url: "" }, { time: "æ™šä¸Š", activity: "æ•´ç†è¡Œæ", note: "æº–å‚™æ˜å¤©å›ç¨‹", url: "" }] },
            "2026-01-18": { label: "1/18 (æ—¥)", location: "ğŸ“ å²¡å±± â†’ æ©Ÿå ´", items: [{ time: "ä¸Šåˆ", activity: "å²¡å±±å¸‚å€", note: "æ—©é¤ã€æœ€å¾Œæ•£æ­¥", url: "" }, { time: "11:00", activity: "å²¡å±±æ¡ƒå¤ªéƒæ©Ÿå ´", note: "å‡ºç™¼å‰å¾€æ©Ÿå ´", url: "" }, { time: "15:00", activity: "é£›æ©Ÿèµ·é£›", note: "Bye Bye å²¡å±±ï¼", url: "" }] }
        };

        // ç‹€æ…‹ç®¡ç†
        let currentData = {};
        let activeDateKey = "2026-01-10";
        const root = document.documentElement;
        const DATA_STORAGE_KEY = 'trip_data_v7'; 

        // --- ä¸»é¡Œå‡½æ•¸ (ç„¡è®Šå‹•) ---
        function saveTheme(themeName, colors = null) {
            const themeToSave = colors || THEMES[themeName];
            localStorage.setItem('tripTheme', JSON.stringify(themeToSave));
            document.getElementById('color-primary').value = themeToSave.primary;
            document.getElementById('hex-primary').value = themeToSave.primary;
            document.getElementById('color-accent').value = themeToSave.accent;
            document.getElementById('hex-accent').value = themeToSave.accent;
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('tripTheme');
            let theme = savedTheme ? JSON.parse(savedTheme) : THEMES['setouchi']; 
            applyColors(theme);
            saveTheme(null, theme); 
        }

        function applyColors(colors) {
            root.style.setProperty('--primary', colors.primary);
            root.style.setProperty('--accent', colors.accent);
            root.style.setProperty('--bg-color', colors.bg);
            root.style.setProperty('--card-bg', colors.card);
            root.style.setProperty('--text-color', colors.text);
            
            document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('active'));
            if (colors.name && THEMES[Object.keys(THEMES).find(key => THEMES[key].name === colors.name)]) {
                document.querySelector(`.preview-${Object.keys(THEMES).find(key => THEMES[key].name === colors.name)}`).classList.add('active');
            }
        }

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            applyColors(theme);
            saveTheme(themeName);
        }

        function applyCustomColors() {
            const customColors = {
                primary: document.getElementById('hex-primary').value.trim(),
                accent: document.getElementById('hex-accent').value.trim(),
                bg: '#f4f6f7', 
                card: '#ffffff',
                text: '#333',
                name: 'è‡ªè¨‚ä¸»é¡Œ'
            };
            applyColors(customColors);
            saveTheme(null, customColors);
            closeModal();
        }

        // --- Modal å‡½æ•¸ (ç„¡è®Šå‹•) ---
        const modal = document.getElementById('designModal');
        function openModal() { modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // --- è¡Œç¨‹å‡½æ•¸ ---

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå°‡æ™‚é–“æ ¼å¼è½‰æ›ç‚ºæ•¸å­—ï¼Œä»¥ä¾¿é€²è¡Œæ’åºã€‚
         */
        function timeToSortableValue(timeString) {
            const t = timeString.trim().toLowerCase();
            if (t.match(/^\d{1,2}:\d{2}$/)) { // ä¿®æ­£ç‚ºæ”¯æ´ 1:00 æˆ– 11:00
                const parts = t.split(':');
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            
            // è™•ç†éæ¨™æº–æ™‚é–“é—œéµå­—ï¼Œè³¦äºˆå›ºå®šæ•¸å€¼é€²è¡Œæ’åº (ç¢ºä¿ 'é¸é …A' åœ¨ 'é¸é …B' å‰é¢)
            switch (t) {
                case 'é¸é …a': return 600; // 10:00
                case 'ä¸Šåˆ': return 660; // 11:00
                case 'ä¸­åˆ': return 720; // 12:00
                case 'ä¸‹åˆ': return 840; // 14:00
                case 'å‚æ™š': return 960; // 16:00
                case 'æ™šä¸Š': return 1140; // 19:00
                case 'é¸é …b': return 1260; // 21:00
                case 'ä½å®¿': return 1380; // 23:00
                default:
                    // å…¶ä»–æ–‡å­—æ’åœ¨æœ€å¾Œ
                    return 9999;
            }
        }
        
        function init() {
            loadTheme();
            const saved = localStorage.getItem(DATA_STORAGE_KEY);
            
            if (saved) {
                try {
                    currentData = JSON.parse(saved);
                } catch (e) {
                    // å¦‚æœè³‡æ–™ææ¯€ï¼Œä½¿ç”¨é è¨­è³‡æ–™
                    currentData = JSON.parse(JSON.stringify(defaultData));
                    console.error("Local data corrupted, using default data.", e);
                }
            } else {
                currentData = JSON.parse(JSON.stringify(defaultData));
            }
            
            // ç¢ºä¿æœ‰ç¬¬ä¸€å¤©çš„è¡Œç¨‹
            const dateKeys = Object.keys(currentData).sort();
            if (!currentData[activeDateKey] && dateKeys.length > 0) {
                activeDateKey = dateKeys[0];
            }
            
            // ç¢ºä¿æ¯å€‹é …ç›®éƒ½æœ‰ url æ¬„ä½
            dateKeys.forEach(dateKey => {
                currentData[dateKey].items.forEach(item => {
                    if (item.url === undefined) { item.url = ""; }
                });
            });

            renderTabs();
            renderList();
            
            // æª¢æŸ¥ URL hash (ç”¨æ–¼è·³è½‰/é«˜äº®)
            const hash = window.location.hash.substring(1);
            if (hash) {
                const element = document.getElementById(hash);
                if (element) {
                    element.classList.add('highlight');
                    // ç¢ºä¿æ»¾å‹•åˆ°è¦–é‡ç¯„åœå…§
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // æ¸…é™¤ hashï¼Œé¿å…ä¸‹æ¬¡è¼‰å…¥æ™‚ä¹Ÿé«˜äº®
                    setTimeout(() => {
                        window.history.replaceState(null, null, window.location.pathname + window.location.search);
                    }, 2000); 
                }
            }
        }

        function renderTabs() { 
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';
            
            Object.keys(currentData).sort().forEach(key => {
                const btn = document.createElement('button');
                btn.className = `date-tab ${key === activeDateKey ? 'active' : ''}`;
                btn.innerText = currentData[key].label;
                btn.onclick = () => {
                    activeDateKey = key;
                    renderTabs();
                    renderList();
                };
                container.appendChild(btn);
            });
        }
        
        function renderList() { 
            const dayData = currentData[activeDateKey];
            document.getElementById('current-date-display').innerText = dayData.label;
            document.getElementById('current-location-display').innerText = dayData.location;
            
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            // æ ¹æ“š time æ¬„ä½é€²è¡Œæ’åº
            dayData.items.sort((a, b) => {
                return timeToSortableValue(a.time) - timeToSortableValue(b.time);
            });
            
            dayData.items.forEach((item, index) => {
                let mapUrl;
                let mapIcon;

                if (item.url && item.url.trim() !== '') {
                    mapUrl = item.url;
                    mapIcon = 'ğŸ”—';
                } else {
                    const mapQuery = encodeURIComponent(item.activity + " " + dayData.location.replace("ğŸ“ ", ""));
                    // ä¿®æ­£ Google Maps æœå°‹é€£çµ
                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;
                    mapIcon = 'ğŸ—ºï¸';
                }

                const urlStatusHtml = (item.url && item.url.trim() !== '') 
                    ? `<div class="url-status"> (å·²é€£çµ) </div>` 
                    : '';
                
                // ç‚ºæ¯å€‹å¡ç‰‡æ·»åŠ ä¸€å€‹ç¨ç‰¹çš„ IDï¼Œç”¨æ–¼è·³è½‰å’Œé«˜äº®
                const itemId = `${activeDateKey}-${index}`;

                const div = document.createElement('div');
                div.className = 'card';
                div.id = itemId; // è¨­å®š ID
                div.innerHTML = `
                    <div class="time-box">${item.time}</div>
                    <div class="content-box">
                        <div class="activity">${item.activity}</div>
                        <div class="note">${item.note}</div>
                        ${urlStatusHtml}
                    </div>
                    <div class="action-icons">
                        <a href="${mapUrl}" target="_blank" class="icon-btn btn-map" title="${item.url ? 'æ‰“é–‹ç²¾ç¢ºé€£çµ' : 'Google Map æœå°‹'}">
                            ${mapIcon}
                        </a>
                        <button class="icon-btn btn-edit" onclick="editItem('${itemId}')" title="ç·¨è¼¯">
                            âœï¸
                        </button>
                        <button class="icon-btn btn-del" onclick="deleteItem('${itemId}')" title="åˆªé™¤">
                            âœ•
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šå¡ç‰‡ ID æ‰¾åˆ°å…¶åœ¨ items é™£åˆ—ä¸­çš„ç´¢å¼•
        function findItemIndexById(itemId) {
            const [dateKey, index] = itemId.split('-');
            // æ³¨æ„ï¼šé€™è£¡åªæª¢æŸ¥ dateKey æ˜¯å¦ç­‰æ–¼ activeDateKeyï¼Œ
            // ç”±æ–¼æ’åºå¾Œ index å¯èƒ½æ”¹è®Šï¼Œæˆ‘å€‘å¿…é ˆå¾é ­é–‹å§‹æ‰¾
            
            if (dateKey !== activeDateKey) return -1; 
            
            // ç”±æ–¼ renderList() æœƒæ’åºï¼Œindex ä¸å†æ˜¯åŸå§‹ indexï¼Œ
            // ä½†æˆ‘å€‘ä½¿ç”¨ ID æ˜¯ç‚ºäº†åœ¨ renderList() åŸ·è¡Œå¾Œèƒ½è®“å…ƒç´ æ‰¾åˆ°è‡ªå·±ã€‚
            // åœ¨ edit/delete æ™‚ï¼Œæˆ‘å€‘éœ€è¦ç”¨æ–° indexï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ¯”å°ã€‚
            
            const items = currentData[activeDateKey].items;
            
            // ç”±æ–¼ items å·²ç¶“è¢«æ’åºï¼Œæˆ‘å€‘éœ€è¦ç”¨ activity å’Œ time æ‰¾å›åŸå§‹ç‰©ä»¶
            // ç”±æ–¼æˆ‘å€‘æ²’æœ‰å…¶ä»–å”¯ä¸€ IDï¼Œé€™æ˜¯ä¸€å€‹æ½›åœ¨çš„é¢¨éšªï¼Œä½†ç›®å‰åªèƒ½å‡è¨­
            // é»æ“Š edit/delete æ™‚ï¼Œå‚³å…¥çš„ itemId å°æ‡‰çš„æ˜¯ç•¶å‰ sorted list çš„ index
            return parseInt(index); 
        }

        // ä¿®å¾©: findItemIndexById åƒ…ç”¨æ–¼åœ¨åŸ·è¡Œæ™‚ç²å–ç•¶å‰æ¸²æŸ“åˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚
        function findCurrentIndex(itemId) {
            const [dateKey, index] = itemId.split('-');
            if (dateKey !== activeDateKey) return -1;
            return parseInt(index);
        }

        window.addNewItem = function() {
            const time = prompt("è¼¸å…¥æ™‚é–“ (å¦‚: 14:00 æˆ– ä¸Šåˆ):");
            if(time === null || time.trim() === '') return;
            
            const activity = prompt("è¼¸å…¥åœ°é»/æ´»å‹• (å¦‚: å²¡å±±åŸ):");
            if(!activity || activity.trim() === '') return;

            const note = prompt("å‚™è¨»:") || "";
            const url = prompt("Google Map é€£çµ (å¯é¸ï¼Œç›´æ¥è²¼ä¸Šç¶²å€):") || "";

            currentData[activeDateKey].items.push({ time, activity, note, url });
            
            // åœ¨ä¿å­˜ä¸¦é‡æ–°æ¸²æŸ“å¾Œï¼Œæ–°çš„é …ç›®æœƒè¢«æ’åºåˆ°æ­£ç¢ºä½ç½®ã€‚
            // é€™è£¡ç„¡æ³•é çŸ¥æ–°é …ç›®çš„æœ€çµ‚ indexï¼Œæ‰€ä»¥æˆ‘å€‘å°‡ hash è¨­å®šç‚ºæœ€å¾Œä¸€å€‹ index è®“ init å‡½æ•¸è™•ç†
            const tempIndex = currentData[activeDateKey].items.length - 1; 
            
            // å°‡æ–°å¢çš„é …ç›® ID å¯«å…¥ URL hashï¼Œinit() åŸ·è¡Œ renderList() å¾Œæœƒæ‰¾åˆ°ä¸¦é«˜äº®å®ƒ
            window.location.hash = `${activeDateKey}-${tempIndex}`; 
            saveAndRender(); 
        }

        window.editItem = function(itemId) {
            const index = findCurrentIndex(itemId);
            if (index === -1 || index >= currentData[activeDateKey].items.length) return;

            const item = currentData[activeDateKey].items[index];
            
            const newTime = prompt("ä¿®æ”¹æ™‚é–“ (æœƒè‡ªå‹•æ’åº):", item.time);
            if (newTime === null) return;

            const newActivity = prompt("ä¿®æ”¹åœ°é»/æ´»å‹•:", item.activity);
            if (newActivity === null) return;

            const newNote = prompt("ä¿®æ”¹å‚™è¨»:", item.note);
            if (newNote === null) return;
            
            const newUrl = prompt("ä¿®æ”¹ Google Map é€£çµ:", item.url || "");
            if (newUrl === null) return;

            // æ›´æ–°è³‡æ–™
            item.time = newTime;
            item.activity = newActivity;
            item.note = newNote;
            item.url = newUrl.trim();

            // å°‡ç·¨è¼¯çš„é …ç›® ID å¯«å…¥ URL hashï¼Œé‡æ–°æ¸²æŸ“å¾Œæœƒæ‰¾åˆ°ä¸¦é«˜äº®å®ƒ
            window.location.hash = itemId; 
            saveAndRender();
        }

        window.deleteItem = function(itemId) {
            const index = findCurrentIndex(itemId);
            if (index === -1 || index >= currentData[activeDateKey].items.length) return;
            
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) {
                currentData[activeDateKey].items.splice(index, 1);
                saveAndRender();
            }
        }

        window.resetData = function() {
            if(confirm("è­¦å‘Šï¼šç¢ºå®šè¦é‡ç½®å›é è¨­è¡Œç¨‹å—ï¼Ÿæ‰€æœ‰ä¿®æ”¹å°‡æ°¸ä¹…æ¶ˆå¤±ã€‚")) {
                localStorage.removeItem(DATA_STORAGE_KEY); 
                localStorage.removeItem('tripTheme'); 
                location.reload(); 
            }
        }

        function saveAndRender() {
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(currentData));
            renderList();
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>

